name: Update Last Work Card

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Detect latest contributed repository
        run: |
          PROFILE_REPO="Damavarun/Damavarun"

          FULL_REPO=$(curl -s https://api.github.com/users/Damavarun/events/public \
            | jq -r --arg profile "$PROFILE_REPO" '
              .[]
              | select(.type=="PushEvent")
              | select(.repo.name != $profile)
              | .repo.name
            ' | head -n 1)

          OWNER=$(echo "$FULL_REPO" | cut -d'/' -f1)
          REPO=$(echo "$FULL_REPO" | cut -d'/' -f2)

          echo "OWNER=$OWNER" >> $GITHUB_ENV
          echo "REPO=$REPO" >> $GITHUB_ENV

      - name: Update README with repo card
        run: |
          awk -v owner="$OWNER" -v repo="$REPO" '
          BEGIN {in_block=0}
          /<!-- CURRENT_PROJECT_START -->/ {
            print;
            print "<p align=\"left\">";
            print "  <img src=\"https://github-readme-stats.vercel.app/api/pin/?username=" owner "&repo=" repo "&theme=dark&hide_border=true&border_radius=12\" />";
            print "</p>";
            in_block=1;
            next
          }
          /<!-- CURRENT_PROJECT_END -->/ {
            in_block=0;
            print;
            next
          }
          !in_block { print }
          ' README.md > README.tmp

          mv README.tmp README.md

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git commit -am "chore: auto-update last work card" || echo "No changes"
          git push
